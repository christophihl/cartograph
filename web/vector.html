<html>

  <head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>The Map of World Knowledge</title>

    <link rel="stylesheet" href="css/leaflet.css" />
    <link rel="stylesheet" href="css/auto-complete.css"/>
    <link rel="stylesheet" type="text/css" href="css/tooltipster.bundle.min.css" />
    <link rel="stylesheet" type="text/css" href="css/tooltipster.shadow.min.css" />

    <script src="js/jquery.min.js"></script>
    <script src="js/jquery.autocomplete.js"></script>
    <script type="text/javascript" src="js/tooltipster.bundle.min.js"></script>

    <style>
        body {
            margin: 0px;
            border: 0px;
            padding: 0px;
        }

        #map {
            height: 100%;
            width: 100%;
            position: absolute;
        }

        #search {
          width: 200px;
          height: 30px;
          position: absolute;
          top: 20px;
          left: 50px;
          z-index: 1000000;
          box-shadow: 5px 5px 5px #888888;
        }

        #search input {
          font-size: 16px;
          padding: 5px;
          width: 100%;
          height: 100%;
        }

        #tooltip {
          position: fixed;
          top: 100px;
          left: 100px;
          z-index: 100000;
          width: 5px;
          height: 5px;
          cursor: pointer;
          background-color: #f00;
        }

        .autocomplete-suggestions { -webkit-box-sizing: border-box; -moz-box-sizing: border-box; box-sizing: border-box; border: 1px solid #999; background: #FFF; cursor: default; overflow: auto; -webkit-box-shadow: 1px 4px 3px rgba(50, 50, 50, 0.64); -moz-box-shadow: 1px 4px 3px rgba(50, 50, 50, 0.64); box-shadow: 1px 4px 3px rgba(50, 50, 50, 0.64); }
        .autocomplete-suggestion { padding: 2px 5px; white-space: nowrap; overflow: hidden; }
        .autocomplete-no-suggestion { padding: 2px 5px;}
        .autocomplete-selected { background: #F0F0F0; }
        .autocomplete-suggestions strong { font-weight: bold; color: #000; }
        .autocomplete-group { padding: 2px 5px; }
        .autocomplete-group strong { font-weight: bold; font-size: 16px; color: #000; display: block; border-bottom: 1px solid #000; }


    </style>
  </head>

  <body>
    <div id="tooltip">&nbsp;</div>
    <div id="map"></div>
    <div id="search">
        <input id="search-field" type="text" placeholder="Search the map">
    </div>

    <!-- leaflet -->
    <script src="js/leaflet.js"></script>

    <!-- Main tangram library -->
    <script src="js/tangram.debug.js"></script>
<!---->
     Demo setup
    <script>

        var map = L.map('map');
        var mapEl = $("#map");  // optimization
        var ttEl = $("#tooltip");

        var layer = Tangram.leafletLayer({
            scene: 'scene.yaml',
            attribution: '<a href="https://mapzen.com/tangram" target="_blank">Tangram</a> | &copy; OSM contributors | <a href="https://mapzen.com/" target="_blank">Mapzen</a>'
        });

        layer.addTo(map);
        layer.scene.subscribe({
          load : function(e) {
            layer.setSelectionEvents({
               hover: function(selection) {
                 if (selection.feature && selection.feature.properties.city) {
                   var ev = selection.leaflet_event.originalEvent;
                   $('selector').css( 'cursor', 'pointer' );
                   handleCityHover(
                           ev.clientX,
                           ev.clientY,
                           selection.feature.properties.city);
                 } else {
                   cancelCityHover();
                 }
               },
               click: function(selection) {
                 if (selection.feature && selection.feature.properties.city) {
                   var ev = selection.leaflet_event.originalEvent;
                   $('selector').css( 'cursor', 'pointer' );
                   handleCityHover(
                           ev.clientX,
                           ev.clientY,
                           selection.feature.properties.city);
                 } else {
                   cancelCityHover();
                 }
               }
            });
          },
          error: function (e) {
              console.log('scene error:', e);
          },
          warning: function (e) {
              console.log('scene warning:', e);
          }
        });

        map.setView([0, 0], 4);

        $('#search-field').autocomplete({
            serviceUrl: '../search',
            paramName: 'q',
            autoSelectFirst: true,
            onSelect: function (suggestion) {
              var info = suggestion.data;
              map.flyTo(info.loc, info.zoom, { duration : 0.4 });
              L.marker(info.loc).addTo(map);
            }
        });

        ttEl.tooltipster({
            content: 'Loading...',
            theme: 'tooltipster-shadow',
            contentAsHTML: true,
            trigger: 'custom',
            triggerOpen: {},
            interactive: true,
            delay: [0, 1000],
            maxWidth: 400,
            triggerClose: {
                mouseleave: true,
                originClick: true,
                touchleave: true
            }
        });


        var ttShowTimer;
        var ttHideTimer;
        var tt = ttEl.tooltipster("instance");

        function handleCityHover(mapX, mapY, title) {
          clearTimeout(ttHideTimer);
          ttHideTimer = 0;

          if (ttShowTimer && ttEl.data("toLoad") == title) {
            return; // in progress!
          }
          ttEl.data("toLoad", title);
          if (ttShowTimer) {
            clearTimeout(ttShowTimer);
          }
          ttShowTimer = setTimeout(function () {
            ttShowTimer = null;
            showCityTooltip(mapX, mapY, title);
          }, 300);
        }

        function cancelCityHover() {
          clearTimeout(ttShowTimer);
          ttShowTimer = 0;
          if (tt.status().open && !ttHideTimer) {
            ttHideTimer = setTimeout(function () {
              ttHideTimer = null;
              tt.close();
              }, 1000);
          }
        }

        function showCityTooltip(mapX, mapY, title) {
          var isOpen = tt.status().open;
          if (ttEl.data("loading") == title) {
            if (!isOpen) tt.open();
            return;
          }
          ttEl.data("loading", title);

           var offset = mapEl.offset();
           ttEl.offset({
             top : offset.top + mapY - ttEl.height() / 2,
             left : offset.left + mapX - ttEl.width() / 2,
           });

          var html = '<b>' + title + '</b><br/>loading...';
          tt.content(html);
          tt.open();
          if (isOpen) {
            tt.reposition();
          }
          var encoded = encodeURIComponent(title);
          var uri = 'https://en.wikipedia.org/w/api.php?action=query&format=json&titles=' + encoded + '&prop=pageimages|extracts&exintro&explaintext&exchars=400&callback=?';
          $.getJSON(uri, function(json){
            var info = null;
            for (var pageId in json.query.pages) {
              info = json.query.pages[pageId];
              break;
            }
            var text = info.extract;
            var img = info.thumbnail;
            var html = "";
            if (img) {
              html += '<img align=left src="' + img.source + '" width=' + img.width + ' height=' + img.height + '>';
            }
            html += '<b>' + title + ':</b> &nbsp; &nbsp;' + text;

            var wpUrl = 'http://en.wikipedia.org/wiki/' + encoded;
            html += '[<a target="_new" href="' + wpUrl + '">see Wikipedia article</a>]';

            // call the 'content' method to update the content of our tooltip with the returned data
            tt.content(html);

            // to remember that the data has been loaded
            ttEl.data('loaded', title);

            if (!ttEl.data("mouseInBound")) {
              ttEl.data("mouseInBound", true);
              $(".tooltipster-base").on("mouseenter", function() {
                clearTimeout(ttHideTimer);
                ttHideTimer = null;
              });
            }
          });
        }

    </script>

  </body>
</html>